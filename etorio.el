;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;; XPM Images
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

(defconst etorio-iron-xpm
  '(image :type xpm :data"\
/* XPM */
static char * target_xpm[] = {
\"32 32 3 1\",
\"  c None\",
\". c black\",
\"X c grey\",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"       .   .   .   .   .        \",
\"      .X. .X. .X. .X. .X.       \",
\"       .   .   .   .   .        \",
\"                                \",
\"       .   .   .   .   .        \",
\"      .X. .X. .X. .X. .X.       \",
\"       .   .   .   .   .        \",
\"                                \",
\"       .   .   .   .   .        \",
\"      .X. .X. .X. .X. .X.       \",
\"       .   .   .   .   .        \",
\"                                \",
\"       .   .   .   .   .        \",
\"      .X. .X. .X. .X. .X.       \",
\"       .   .   .   .   .        \",
\"                                \",
\"       .   .   .   .   .        \",
\"      .X. .X. .X. .X. .X.       \",
\"       .   .   .   .   .        \",
\"                                \",
\"       .   .   .   .   .        \",
\"      .X. .X. .X. .X. .X.       \",
\"       .   .   .   .   .        \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
};
" :ascent center :mask (heuristic t) :margin 0))


(defconst etorio-copper-xpm
  '(image :type xpm :data"\
/* XPM */
static char * target_xpm[] = {
\"32 32 3 1\",
\"  c None\",
\". c black\",
\"X c brown\",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"       .   .   .   .   .        \",
\"      .X. .X. .X. .X. .X.       \",
\"       .   .   .   .   .        \",
\"                                \",
\"       .   .   .   .   .        \",
\"      .X. .X. .X. .X. .X.       \",
\"       .   .   .   .   .        \",
\"                                \",
\"       .   .   .   .   .        \",
\"      .X. .X. .X. .X. .X.       \",
\"       .   .   .   .   .        \",
\"                                \",
\"       .   .   .   .   .        \",
\"      .X. .X. .X. .X. .X.       \",
\"       .   .   .   .   .        \",
\"                                \",
\"       .   .   .   .   .        \",
\"      .X. .X. .X. .X. .X.       \",
\"       .   .   .   .   .        \",
\"                                \",
\"       .   .   .   .   .        \",
\"      .X. .X. .X. .X. .X.       \",
\"       .   .   .   .   .        \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
};
" :ascent center :mask (heuristic t) :margin 0))


(defconst etorio-wood-xpm
  '(image :type xpm :data"\
/* XPM */
static char * target_xpm[] = {
\"32 32 4 1\",
\"  c None\",
\". c black\",
\"g c green\",
\"b c brown\",
\"                                \",
\"                                \",
\"     .                          \",
\"    .g.        .......          \",
\"   .ggg.      .ggggggg.         \",
\"  .ggggg.     .ggggggg.         \",
\"  ..ggg..      ..ggg..          \",
\"   .bbb.        .bbb.           \",
\"   .bbb.        .bbb.           \",
\"   .....        .....           \",
\"                                \",
\"           ..........           \",
\"          .bbbbbbbbbb.          \",
\"         .bbbbbbbbbbbb.         \",
\"        .bbbbbbbbbbbbbb.        \",
\"        .bbbbbbbbbbbbbb.        \",
\"        .bbbbbbbbbbbbbb.        \",
\"        .bbbbbbbbbbbbbb.        \",
\"         .bbbbbbbbbbbb.         \",
\"          .bbbbbbbbbb.          \",
\"           ..........           \",
\"                                \",
\"     .                          \",
\"    .g.        .......          \",
\"   .ggg.      .ggggggg.         \",
\"  .ggggg.     .ggggggg.         \",
\"  ..ggg..      ..ggg..          \",
\"   .bbb.        .bbb.           \",
\"   .bbb.        .bbb.           \",
\"   .....        .....           \",
\"                                \",
\"                                \",
};
" :ascent center :mask (heuristic t) :margin 0))


(defconst etorio-player-xpm
  '(image :type xpm :data "\
/* XPM */
static char * target_xpm[] = {
\"32 32 3 1\",
\"  c None\",
\". c green\",     
\"X c red\",       
\"                                \",
\" .....                    ..... \",
\" .XXX.                    .XXX. \",
\" .X...                    ...X. \",
\" .X.                        .X. \",
\" ...                        ... \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\" ...                        ... \",
\" .X.                        .X. \",
\" .X...                    ...X. \",
\" .XXX.                    .XXX. \",
\" .....                    ..... \",
\"                                \",
};                              
"  :ascent center :mask (heuristic t) :margin 0))


(defconst etorio-belt-xpm
  '(image :type xpm :data "\
/* XPM */
static char * target_xpm[] = {
\"32 32 3 1\",
\"  c None\",
\". c black\",     
\"X c lightgray\",                 
\"             .......            \",
\"             .XXXXX.            \",
\"             .XXXXX.            \",
\"             .XXXXX.            \",
\"             .XXXXX.            \",
\"             .XXXXX.            \",
\"             .XXXXX.            \",
\"             .XXXXX.            \",
\"             .XXXXX.            \",
\"             .XXXXX.            \",
\"             .XXXXX.            \",
\"             .XXXXX.            \",
\"..............XXXXX.............\",
\".XXXXXXXXXXXX.XXXXX.XXXXXXXXXXX.\",
\".XXXXXXXXXXXX.XXXXX.XXXXXXXXXXX.\",
\".XXXXXXXXXXXX.XXXXX.XXXXXXXXXXX.\",
\".XXXXXXXXXXXX.XXXXX.XXXXXXXXXXX.\",
\".XXXXXXXXXXXX.XXXXX.XXXXXXXXXXX.\",
\"..............XXXXX.............\",
\"             .XXXXX.            \",
\"             .XXXXX.            \",
\"             .XXXXX.            \",
\"             .XXXXX.            \",
\"             .XXXXX.            \",
\"             .XXXXX.            \",
\"             .XXXXX.            \",
\"             .XXXXX.            \",
\"             .XXXXX.            \",
\"             .XXXXX.            \",
\"             .XXXXX.            \",
\"             .XXXXX.            \",
\"             .......            \",
};                               
"  :ascent center :mask (heuristic t) :margin 0))



(defconst etorio-wall-xpm
  '(image :type xpm :data "\
/* XPM */
static char * target_xpm[] = {
\"32 32 3 1\",
\"  c None\",
\". c black\",     
\"X c cyan\",                 
\" ...........................    \",
\" ..XXXXXXXXXXXXXXXXXXXXXXXXX.   \",
\" .X...........................  \",
\" .X.XXXXXXXXXXXXXXXXXXXXXXXXXX. \",
\" .X.XXXXXXXXXXXXXXXXXXXXXXXXXX. \",
\" .X.XXXXXXXXXXXXXXXXXXXXXXXXXX. \",
\" .X.XXXXXXXXXXXXXXXXXXXXXXXXXX. \",
\" .X.XXXXXXXXXXXXXXXXXXXXXXXXXX. \",
\" .X.XXXXXXXXXXXXXXXXXXXXXXXXXX. \",
\" .X.XXXXXXXXXXXXXXXXXXXXXXXXXX. \",
\" .X.XXXXXXXXXXXXXXXXXXXXXXXXXX. \",
\" .X.XXXXXXXXXXXXXXXXXXXXXXXXXX. \",
\" .X.XXXXXXXXXXXXXXXXXXXXXXXXXX. \",
\" .X.XXXXXXXXXXXXXXXXXXXXXXXXXX. \",
\" .X.XXXXXXXXXXXXXXXXXXXXXXXXXX. \",
\" .X.XXXXXXXXXXXXXXXXXXXXXXXXXX. \",
\" .X.XXXXXXXXXXXXXXXXXXXXXXXXXX. \",
\" .X.XXXXXXXXXXXXXXXXXXXXXXXXXX. \",
\" .X.XXXXXXXXXXXXXXXXXXXXXXXXXX. \",
\" .X.XXXXXXXXXXXXXXXXXXXXXXXXXX. \",
\" .X.XXXXXXXXXXXXXXXXXXXXXXXXXX. \",
\" .X.XXXXXXXXXXXXXXXXXXXXXXXXXX. \",
\" .X.XXXXXXXXXXXXXXXXXXXXXXXXXX. \",
\" .X.XXXXXXXXXXXXXXXXXXXXXXXXXX. \",
\" .X.XXXXXXXXXXXXXXXXXXXXXXXXXX. \",
\" .X.XXXXXXXXXXXXXXXXXXXXXXXXXX. \",
\" .X.XXXXXXXXXXXXXXXXXXXXXXXXXX. \",
\" .X.XXXXXXXXXXXXXXXXXXXXXXXXXX. \",
\" .X.XXXXXXXXXXXXXXXXXXXXXXXXXX. \",
\" .X.XXXXXXXXXXXXXXXXXXXXXXXXXX. \",
\" .X.XXXXXXXXXXXXXXXXXXXXXXXXXX. \",
\" .............................. \",
};                               
"  :ascent center :mask (heuristic t) :margin 0))



(defconst etorio-floor-xpm
  '(image :type xpm :data "\
/* XPM */
static char * target_xpm[] = {
\"32 32 3 1\",
\"  c None\",
\". c black\",
\"X c grey\",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
\"                                \",
};
" :ascent center :mask (heuristic t) :margin 0))

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;; elisp code
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

;; path is valid for straight.el
(defcustom etorio-level1-sound (when load-file-name
                                      (concat (file-name-directory load-file-name)
                                              "../../repos/etorio/music/10-21-23.webm"))
  "The path to a sound file that´s to be played when a timeblock has started."
  :group 'etorio
  :type 'file)

(defun etorio-play-level1-sound ()
  (interactive)
  (start-process "mplayer" nil "mplayer" etorio-level1-sound)
  )

(defun etorio-play-level1-sound-42x ()
  (interactive)
 (start-process "mplayer"  nil  "mplayer" etorio-level1-sound "-loop" "0" "-speed" "0.42")
 )

(defun kill-etorio-sound ()
  (interactive)
 (start-process "killall"  nil  "killall" "killall" "mplayer")
 )


(defun set-etorio-keybindings ()
    (global-set-key (kbd "<left>") 'etorio-move-left)
    (global-set-key (kbd "<right>") 'etorio-move-right)
    (global-set-key (kbd "<up>") 'etorio-move-up)
    (global-set-key (kbd "<down>") 'etorio-move-down)
    (global-set-key (kbd "q") 'etorio-quit)

    )


(defun etorio-press-q ()
 "q"
  )

(defun unset-etorio-keybindings ()
    (global-set-key (kbd "<left>") 'backward-char)
    (global-set-key (kbd "<right>") 'forward-char)
    (global-set-key (kbd "<up>") 'previous-line)
    (global-set-key (kbd "<down>") 'next-line)
    (global-set-key (kbd "q") "q")

  )

(defun etorio-quit ()
  (interactive)
  (kill-etorio-sound)
  (unset-etorio-keybindings)
  (setq cursor-type 'bar)
  (kill-buffer "etorio"))

(defun etorio ()
  (interactive)
  (switch-to-buffer "etorio")
  ;; https://emacs.stackexchange.com/questions/18374/persistently-hide-cursor-evil-mode-problem
  (setq cursor-type nil)
  (etorio-play-level1-sound-42x)
  (set-etorio-keybindings)
  (display-map-as-images-test)
  )

;; X = wall
;; . = coal
;; w = wood
;; c = copper
;; i = iron
;; a = aqua (water)
(setq level1-map-old
"XXXXX
X...X
X...X
X...X
XXXXX"
)

;; map char in map (represented as a 'symbol) to it's corresponding xpm image
(setq map-char-to-xpm-plist (list
                'c etorio-copper-xpm
                'i etorio-iron-xpm
                'w etorio-wood-xpm
                '@ etorio-player-xpm
                'b etorio-belt-xpm
                '\  etorio-floor-xpm
                '\\  etorio-player-xpm
                '\# etorio-wall-xpm
                '\n etorio-player-xpm))


(setq level1-map-modified
"#        ww    bb#
###################
#                 #
#                 #
#      i      cc  #
#      i      cc  #
#         ww      #
#               bb#
#          @    bb#
#                 #
###################")

(setq level1-map
"###################
#                 #
#                 #
#      i      cc  #
#      i      cc  #
#         ww      #
#         ww    bb#
#               bb#
#          @    bb#
#                 #
###################")

(defun map-length (map)
  (length map)
  )

;; (0, 0) top left
;; (32, 32) bottom right

;; x is horizontal
;;  1 = right
;;  0 = no change
;;  -1 = left

;; y is vertical
;;  1 = down
;;  0 = no change
;;  -1 = up

;; https://stackoverflow.com/questions/14805167/defining-key-binding-with-arguments
(defun etorio-move-left ()
  (interactive)
  (etorio-move -1 0)
  )

(defun etorio-move-right ()
  (interactive)
  (etorio-move 1 0)
  )

(defun etorio-move-up ()
  (interactive)
  (etorio-move 0 -1)
  )

(defun etorio-move-down ()
  (interactive)
  (etorio-move 0 1)
  )

(defun etorio-move (dx dy)
  (if (eq dx -1)
      (left-char)
      )
  
 (if (eq dx 1)
      (right-char)
 )

 (if (eq dy -1)
     (previous-line)
     ) 

 (if (eq dy 1)
     (next-line)
     )
)

;; https://stackoverflow.com/questions/3115104/how-to-create-keybindings-for-a-custom-minor-mode-in-emacs
(defvar etorio-mode-map
  (let ((map (make-sparse-keymap)))
    (set-keymap-parent map parent-mode-shared-map)
    (define-key map (kbd "<left>") 'etorio-move-left)
    (define-key map (kbd "<right>") 'etorio-move-right)
    (define-key map (kbd "<up>") 'etorio-move-up)
    (define-key map (kbd "<down>") 'etorio-move-down)
    map)
  )

;; https://emacs.stackexchange.com/questions/5358/proper-way-to-enable-minor-mode
(add-hook 'etorio-mode-hook #'etorio-mode)

;; https://systemcrafters.net/learning-emacs-lisp/creating-minor-modes/
(add-to-list 'minor-mode-alist '(etorio-basic-mode "*etorio*"))
(add-to-list 'minor-mode-map-alist (cons 'etorio-mode etorio-mode-map))


  ;;(use-local-map etorio-mode-map)

  
;; (defvar etorio-mode-map
;;   (let ((map (make-keymap)))
;;     (define-key map "left" (etorio-move 1 0))
;;     (define-key map "right" (etorio-move -1 0))
;;     (define-key map "up" (etorio-move 0 1))
;;     (define-key map "don" (etorio-move 0 -1))
;;     map)
;;   "Keymap for etorio major mode")

(defun display-map-updates-test ()
  (interactive)
  (display-map-as-images level1-map)
  (display-map-as-images level2-map)
  )

(defun display-map-as-images-test ()
  (interactive)
  (display-map-as-images level1-map)
)

(defun display-map-as-images (map)
  (let ((x 1) (map-length-val (map-length map)))
    (while (<= x map-length-val)
      (setq map-symbol-name (substring level1-map (- x 1) x))
      (setq map-symbol (intern map-symbol-name))
      ;;(insert map-symbol-name)
      (setq map-img (plist-get map-char-to-xpm-plist map-symbol))
      (if (not (eq (mod x 20) 0))
          ;; (insert "\n")
          (if map-img
              (insert-image map-img)
              )
          )
      (if (eq (mod x 20) 0)
          (insert "\n")
          )
      (setq x (1+ x))

      )
    )
  )

(setq map-symbol "a")
(setq map-symbol-name "a")


(defun display-map-as-string (map)
  (let ((x 1) (map-length-val (map-length map)))
    (while (<= x map-length-val)
      (setq map-symbol-name (substring level1-map (- x 1) x))
      (setq map-symbol (intern map-symbol-name))

      (insert map-symbol-name)
      ;;(insert-image (plist-get map-char-to-xpm-plist
      ;;                         map-symbol)
      ;;)
      (setq x (1+ x))
      (if (eq (mod x 20) 0)
          (insert "\n")
          )
      )
    )
  )

(defun display-map-as-string-test ()
  (interactive)
  (display-map level1-map)
)



(setq level2-map
"###################
#                 #
#                 #
#   cc c      cc  #
#   cc c      cc  #
#         ww      #
#         ww    ..#
#   www         ..#
#   www    @    ..#
#                 #
###################")

(setq level-x 5)
(setq level-y 5)

(defun levelToVector (level)
  (insert level)
  )

(defun drawGrid (level)
  (insert level)
  )



(provide 'etorio)
